//**************************************************************************************************
// @Module        SYSTEM_MANAGEMENT
// @Filename      System_Management.c
//--------------------------------------------------------------------------------------------------
// @Platform      PLATFORM_NAME
//--------------------------------------------------------------------------------------------------
// @Compatible    COMPATIBLE_PROCESSOR_MODULE
//--------------------------------------------------------------------------------------------------
// @Description   Implementation of the MODULE functionality.
//                [Description...]
//
//                Abbreviations:
//                  
//                 
//
//                Global (public) functions:
//                  SM_Init()
//                  SM_Task()
//
//                Local (private) functions:
//                  SM_Port_Inactive_0()
//                  SM_Wait_On_DL_Preoperate_2()
//                  SM_Check_Ser_Num_3()
//                  SM_Wait_4()
//                  SM_Operate_5()
//                  
//                  
//
//--------------------------------------------------------------------------------------------------
// @Version       1.0.0
//--------------------------------------------------------------------------------------------------
// @Date          XX.XX.XXXX
//--------------------------------------------------------------------------------------------------
// @History       Version  Author      Comment
// XX.XX.XXXX     1.0.0    XXX         First release.
//**************************************************************************************************



//**************************************************************************************************
// Project Includes
//**************************************************************************************************

// Native header
#include "IO_LINK.h"
#include "System_Management.h"
#include "DL_MessageHandler.h"
#include "Physical_layer.h"
#include "Data_layer.h"
#include "DL_ModeHandler.h"
#include "terminal.h"
#include "software_timer.h"

//**************************************************************************************************
// Verification of the imported configuration parameters
//**************************************************************************************************

// None.


//**************************************************************************************************
// Definitions of global (public) variables
//**************************************************************************************************

// None.


//**************************************************************************************************
// Declarations of local (private) data types
//**************************************************************************************************

// State machine of SM 
typedef enum SM_TypeStateMachine_enum
{
    SM_PORT_INACTIVE_0=0,
    SM_CHECK_COMPATIBILITY_1,
    SM_WAIT_ON_DL_PREOPERATE_2,
    SM_CHECK_SER_NUM_3,
    SM_WAIT_4,
	SM_OPERATE_5
}SM_TypeStateMachine;


//**************************************************************************************************
// Definitions of local (private) constants
//**************************************************************************************************

// None.



//**************************************************************************************************
// Definitions of static global (private) variables
//**************************************************************************************************

// System managment state machine
static SM_TypeStateMachine SM_StateMachine;

// software timer 
static U8 nTimerHandle_SM = 0;

// stored device's prm
static U8 prmPage1[IO_LINK_SIZE_PAGE_1]; 

static U8 prmPage2[IO_LINK_SIZE_PAGE_2]; 

//**************************************************************************************************
// Declarations of local (private) functions
//**************************************************************************************************

static void SM_Port_Inactive_0(void);

static void SM_Check_Compatibility_1(void);

static void SM_Wait_On_DL_Preoperate_2(void);

static void SM_Check_Ser_Num_3(void);

static void SM_Wait_4(void);

static void SM_Operate_5(void);



//**************************************************************************************************
//==================================================================================================
// Definitions of global (public) functions
//==================================================================================================
//**************************************************************************************************



//**************************************************************************************************
// @Function      SM_Init()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//                parameterOne  - [description...]
//**************************************************************************************************
STD_RESULT SM_Init(void)
{
    STD_RESULT nFuncResult = RESULT_OK;
    
    // Create timer nTimerHandle_SM
    if (RESULT_OK == SOFTTIMER_Create(&nTimerHandle_SM))
    {
    #ifdef DEBUG
        TERMINAL_SendMessage("DL_Message Handler was initialized\n\r");
    #endif  
        nFuncResult = RESULT_OK;
    }
    else
    {
        nFuncResult = RESULT_NOT_OK;
    } 
    
    SM_StateMachine = SM_PORT_INACTIVE_0;
    
    return nFuncResult;
    
} // end of SM_Init()



//**************************************************************************************************
// @Function      SM_Task()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//**************************************************************************************************
void SM_Task(void)
{   
        
} // end of Sm_Task()



//**************************************************************************************************
// @Function      SM_SetPortConfig()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//**************************************************************************************************
void SM_SetPortConfig(void)
{
    // Set Port config
    SM_Port_Inactive_0();
    
    // read prm and set mode PREOPERATE
    if (SM_StateMachine == SM_CHECK_COMPATIBILITY_1)
    {
        SM_Check_Compatibility_1();
        
         // Setting device
        SM_Wait_On_DL_Preoperate_2();
    }

}// end of SM_SetPortConfig



//**************************************************************************************************
// @Function      SM_GetPortConfig()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//**************************************************************************************************
void SM_GetPortConfig(void)
{
    
}// end of SM_GetPortConfig



//**************************************************************************************************
// @Function      SM_Operate()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//**************************************************************************************************
void SM_Operate(void)
{
    // Set mode OPERATE
    SM_Operate_5();
    
    SM_StateMachine = SM_OPERATE_5;
    
}// end of SM_Operate



//**************************************************************************************************
// @Function      SM_PortMode()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//**************************************************************************************************
void SM_PortMode(void)
{
    
}// end of SM_PortMode



//**************************************************************************************************
//==================================================================================================
// Definitions of local (private) functions
//==================================================================================================
//**************************************************************************************************



//**************************************************************************************************
// @Function      SM_Port_Inactive_0()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//                parameterOne  - [description...]
//**************************************************************************************************
static void SM_Port_Inactive_0(void)
{
     DL_SetMode(DL_START_UP);
     
     if( DL_START_UP == DL_GetMode())
     {
        SM_StateMachine = SM_CHECK_COMPATIBILITY_1;
     }

//    while( DL_START_UP != DL_GetMode())
//    {
//        #ifdef DEBUG
//            TERMINAL_SendMessage( "DL_SetMode(DL_START_UP)\n\r");
//        #endif   
//        DL_SetMode(DL_START_UP);    
//    }
//    SM_StateMachine = SM_CHECK_COMPATIBILITY_1;
} // end of SM_Port_Inactive_0()



//**************************************************************************************************
// @Function      SM_Check_Compatibility_1()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//                parameterOne  - [description...]
//**************************************************************************************************
static void SM_Check_Compatibility_1(void)
{
    U8 data,addr;
    DL_MES_RESPONSE_TYPE response = {NOT_OK,0};
	
    // read page 1 adr 0x01...0x06
    for(U8 i = 1; i < 7; i++)
    {
        DL_Read(&i,&response);
        prmPage1[i] = response.data;
    } 
    
    // send DEVICE_MASTERIDENT
    addr = MASTER_COMMAND;
    data = DEVICE_MASTERIDENT;
	response.state = NOT_OK;
    DL_Write(&addr,&data,&response);
    
    data = DEVICE_PREOPERATE;
	// set PREOPERATE mode in device
    DL_Write(&addr,&data,&response);
	// set POREOPERATE mode in master
	DL_SetMode(DL_PREOPERATE);

    SM_StateMachine = SM_WAIT_ON_DL_PREOPERATE_2;
      
}// end of SM_Check_Compatibility_1()



//**************************************************************************************************
// @Function      SM_Wait_On_DL_Preoperate_2()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//                parameterOne  - [description...]
//**************************************************************************************************
static void SM_Wait_On_DL_Preoperate_2(void)
{   

    SM_StateMachine = SM_WAIT_4;
    
}// end of SM_Wait_On_DL_Preoperate_2()



//**************************************************************************************************
// @Function      SM_Operate_5()
//--------------------------------------------------------------------------------------------------
// @Description   [description...]
//--------------------------------------------------------------------------------------------------
// @Notes
//--------------------------------------------------------------------------------------------------
// @ReturnValue   returnValue - [description...]
//--------------------------------------------------------------------------------------------------
// @Parameters    parameterZero - [description...]
//                parameterOne  - [description...]
//**************************************************************************************************
static void SM_Operate_5(void)
{   
	U8 data,addr;
    DL_MES_RESPONSE_TYPE response = {NOT_OK,0};
    
    // send DEVICE_OPERATE
    addr = MASTER_COMMAND;
    data = DEVICE_OPERATE;
	response.state = NOT_OK;
    DL_Write(&addr,&data,&response);
	
	DL_SetMode(DL_OPERATE);
	
    data = DEVICE_PROCESS_DATA_OUTPUT_OPERATE;
    response.state = NOT_OK;
    // set OPERATE mode in device
    DL_Write(&addr,&data,&response);

    
}// end of SM_Operate_5()


//****************************************** end of file *******************************************
