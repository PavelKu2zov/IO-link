//**************************************************************************************************
// @Module        DL_MES_HANDLER
// @Filename      DL_MessageHandler.c
//--------------------------------------------------------------------------------------------------
// @Platform      stm32f103
//--------------------------------------------------------------------------------------------------
// @Compatible    
//--------------------------------------------------------------------------------------------------
// @Description   Implementation of the DL Message Handler functionality.
//
//
//                Abbreviations:
//                  DL - Data link layer
//
//
//                 Global (public) functions:
//
//
//
//                Local (private) functions:
//
//
//
//--------------------------------------------------------------------------------------------------
// @Version       1.0.0
//--------------------------------------------------------------------------------------------------
// @Date          30.08.2021
//--------------------------------------------------------------------------------------------------
// @History       Version  Author      Comment
// XX.XX.XXXX     1.0.0    KPS         First release.
//**************************************************************************************************



//**************************************************************************************************
// Project Includes
//**************************************************************************************************

// Native header
#include "DL_MessageHandler_drv.h"
#include "FreeRTOS.h"
#include "task.h"
#include "main.h"


//**************************************************************************************************
// Verification of the imported configuration parameters
//**************************************************************************************************

// None.


//**************************************************************************************************
// Definitions of global (public) variables
//**************************************************************************************************

// None.


//**************************************************************************************************
// Declarations of local (private) data types
//**************************************************************************************************

typedef enum DL_MES_TypeStateMachine_enum
{
    DL_MES_INACTIVE_0=0,
    DL_MES_AWAITREPLY_1,
    DL_MES_STARTUP_2,
    DL_MES_RESPONSE_3,
    DL_MES_PREOPERATE_6,
    DL_MES_GETOD_7,
    DL_MES_RESPONSE_8,
	DL_MES_CHECKHANDLER_11,
    DL_MES_OPERATE_12,
    DL_MES_GETPD_13,
	DL_MES_GETOD_14,
	DL_MES_RESPONSE_15
}DL_MES_TypeStateMachine;


//**************************************************************************************************
// Definitions of local (private) constants
//**************************************************************************************************

//Device detection time 500...1000 ms
#define PL_Tds				   (1000)	
              
//**************************************************************************************************
// Definitions of static global (private) variables
//**************************************************************************************************

static DL_MES_TypeStateMachine DL_MES_StateMachine; 


//**************************************************************************************************
// Declarations of local (private) functions
//**************************************************************************************************

// None.


//**************************************************************************************************
//==================================================================================================
// Definitions of global (public) functions
//==================================================================================================
//**************************************************************************************************

//**************************************************************************************************
// @Function      DL_MES_Init()
//--------------------------------------------------------------------------------------------------
// @Description   Init DL Message handler
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Init(void)
{
    TIM_DeInit(DL_Timer);
	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStruct;
    TIM_TimeBaseInitStruct.TIM_Period = DL_MES_TIMER_PERIOD;
	TIM_TimeBaseInitStruct.TIM_Prescaler = PL_TIMER_PRESCALER;
	TIM_TimeBaseInitStruct.TIM_ClockDivision = TIM_CKD_DIV1;
	TIM_TimeBaseInitStruct.TIM_CounterMode = TIM_CounterMode_Up;
	TIM_TimeBaseInitStruct.TIM_RepetitionCounter = 0x0000;
	TIM_TimeBaseInit(DL_MES_Timer, &TIM_TimeBaseInitStruct);
	
    DL_MES_StateMachine = DL_MES_Inactive_0;
    
}// end of DL_MES_Init()



//**************************************************************************************************
// @Function      DL_MES_Task()
//--------------------------------------------------------------------------------------------------
// @Description   task of Data link layer
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Task(void *pvParameters)
{
	portBASE_TYPE xStatus;
	DLMES_QUEUE PL_TransferInd;
	IN_CALLS MH_Calls;
	DL_MES_Init();
	
	
	for(;;)
	{
		// Get data from MH Queue
		xStatus = xQueueReceive( xMH_Queue,&MH_Calls,0);
		if ( pdPASS == xStatus )
		{
			switch (MH_Calls)
			{
				case MH_CONF_COM1: DL_MES_StateMachine = DL_MES_AWAITREPLY_1; break;
				
				case MH_CONF_COM2: DL_MES_StateMachine = DL_MES_AWAITREPLY_1; break;
				
				case MH_CONF_COM3: DL_MES_StateMachine = DL_MES_AWAITREPLY_1; break;
				
				case MH_CONF_STARTUP: DL_MES_StateMachine = DL_MES_STARTUP_2; break;
				
				case MH_CONF_PREOPERATE: DL_MES_StateMachine = DL_MES_PREOPERATE_6; break;
				
				case MH_CONF_OPERATE: DL_MES_StateMachine = DL_MES_OPERATE_12; break;
				
				case MH_CONF_ACTIVE: break;
				
				case MH_CONF_INACTIVE: DL_MES_StateMachine = DL_MES_INACTIVE_0;break;
				
				default: break;
			}
			
		}
		
		// Call routines
		switch (DL_MES_StateMachine)
		{
			case DL_MES_INACTIVE_0: DL_MES_Inactive_0();break;
			
			case DL_MES_AWAITREPLY_1: DL_MES_AwaitReply_1();break;
			
			case DL_MES_STARTUP_2: DL_MES_StartUp_2();break;
			
			case DL_MES_RESPONSE_3: DL_MES_Response_3();break;
			
			case DL_MES_PREOPERATE_6: DL_MES_Preoperate_6();break;
			
			case DL_MES_GETOD_7: DL_MES_GetOD_7();break;
			
			case DL_MES_RESPONSE_8: DL_MES_Response_8();break;
			
			case DL_MES_CHECKHANDLER_11: DL_MES_CheckHandler_11();break;
			
			case DL_MES_OPERATE_12: DL_MES_Operate_12();break;
			
			case DL_MES_GETPD_13: DL_MES_GetPD_13();break;
			
			case DL_MES_GETOD_14: DL_MES_GetOD_14();break;
			
			case DL_MES_RESPONSE_15: DL_MES_Response_15();break;
			
			default: break;
		}
		
			
		//Get data from PL_Transfer.ind Queue
		//xStatus = xQueueReceive( xPL_TransferIndQueue, &PL_TransferInd, portMAX_DELAY );
		
		
	}
}// end of DL_MES_Task()



//**************************************************************************************************
//==================================================================================================
// Definitions of local (private) functions
//==================================================================================================
//**************************************************************************************************

//**************************************************************************************************
// @Function	  DL_MES_Inactive_0
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Inactive_0(void)
{
	;
}
// end of DL_MES_Inactive_0()



//**************************************************************************************************
// @Function      DL_MES_AwaitReply_1
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    mode - INACTIVE,DI,DO,COM1,COM2,COM3
//**************************************************************************************************
void DL_MES_AwaitReply_1( void );
{
	portTickType xTicksToWait = ((portTickType )PL_Tds) / portTICK_RATE_MS;
	
	//Get data from PL_Transfer.ind Queue
	xStatus = xQueueReceive( xPL_TransferIndQueue, &PL_TransferInd, xTicksToWait  );
	
	if ( pdPASS == xStatus )
	{
		send data up
		
		DL_MES_StateMachine = DL_MES_STARTUP_2;	
	}
	else
	{
		send data up
		
		DL_MES_StateMachine = DL_MES_Inactive_0;
	}
	
}
// end of DL_MES_AwaitReply_1()



//**************************************************************************************************
// @Function      DL_MES_StartUp_2
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_StartUp_2( void )
{
	
}
// end of DL_MES_StartUp_2()



//**************************************************************************************************
// @Function      DL_MES_Response_3
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Response_3( void )
{
	
}
// end of DL_MES_Response_3()



//**************************************************************************************************
// @Function      DL_MES_Preoperate_6
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Preoperate_6( void )
{
	
}
// end of DL_MES_Preoperate_6()



//**************************************************************************************************
// @Function      DL_MES_GetOD_7
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_GetOD_7( void )
{
	
}
// end of DL_MES_GetOD_7()



//**************************************************************************************************
// @Function      DL_MES_Response_8
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Response_8( void )
{
	
}
// end of DL_MES_Response_8()



//**************************************************************************************************
// @Function      DL_MES_CheckHandler_11
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_CheckHandler_11( void )
{
	
}
// end of DL_MES_CheckHandler_11()



//**************************************************************************************************
// @Function      DL_MES_Operate_12
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Operate_12( void )
{
	
}
// end of DL_MES_Operate_12()



//**************************************************************************************************
// @Function      DL_MES_GetPD_13
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_GetPD_13( void )
{
	
}
// end of DL_MES_GetPD_13()



//**************************************************************************************************
// @Function      DL_MES_GetOD_14
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_GetOD_14( void )
{
	
}
// end of DL_MES_GetOD_14()



//**************************************************************************************************
// @Function      DL_MES_Response_15
//--------------------------------------------------------------------------------------------------
// @Description   None.
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void DL_MES_Response_15( void )
{
	
}
// end of DL_MES_Response_15()



//**************************************************************************************************
// @Function      PL_Delay
//--------------------------------------------------------------------------------------------------
// @Description   Delay for PL. It bases on PL_TIMER
//--------------------------------------------------------------------------------------------------
// @Notes         None.
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    time in us
//**************************************************************************************************
void PL_Delay( uint16_t time )
{
	TIM_Cmd(PL_Timer, DISABLE);
	TIM_ClearFlag(PL_Timer, TIM_FLAG_Update);
	TIM_SetAutoreload(PL_TIMER, time*PL_K);
	//wait
	TIM_Cmd(PL_Timer, ENABLE);
	while(RESET != TIM_GetFlagStatus(PL_Timer, TIM_FLAG_Update));
	TIM_Cmd(PL_Timer, DISABLE);
}
// end of PL_Delay()




//****************************************** end of file *******************************************
