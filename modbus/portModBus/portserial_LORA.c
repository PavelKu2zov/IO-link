//**************************************************************************************************
// @Module        PORT_SERIAL
// @Filename      portserial.c
//--------------------------------------------------------------------------------------------------
// @Platform      STM8S
//--------------------------------------------------------------------------------------------------
// @Compatible    STM8S-discovery board
//--------------------------------------------------------------------------------------------------
// @Description   Implementation of the PORT_SERIAL functionality.
//                
//
//                Abbreviations:
//                  None.
//                
//
//                Global (public) functions:
//                  
//                  
//
//                Local (private) functions:
//                  
//                  
//
//--------------------------------------------------------------------------------------------------
// @Version       1.0.0
//--------------------------------------------------------------------------------------------------
// @Date          25.08.2021
//--------------------------------------------------------------------------------------------------
// @History       Version  Author      Comment
// XX.XX.XXXX     1.0.0    KPS         First release.
//**************************************************************************************************



//**************************************************************************************************
// Project Includes
//**************************************************************************************************

/* ----------------------- Platform includes --------------------------------*/
#include "stdlib.h"
#include "port.h"
#include "ModuleRAK811.h"
#include "stdio.h"
#include "IO_LINK.h"
/* ----------------------- Modbus includes ----------------------------------*/
#include "mb.h"
#include "mbport.h"

//**************************************************************************************************
// Verification of the imported configuration parameters
//**************************************************************************************************

// None.



//**************************************************************************************************
// Definitions of global (public) variables
//**************************************************************************************************

// None.


//**************************************************************************************************
// Declarations of local (private) data types
//**************************************************************************************************

// None.



//**************************************************************************************************
// Definitions of local (private) constants
//**************************************************************************************************

#define SIZE_TX_BUFF                (U16)(128)
    


//**************************************************************************************************
// Definitions of static global (private) variables
//**************************************************************************************************

static char ModBusRXByte = 0;

//state of transmiter
static BOOL RxEnable = FALSE;
static BOOL TxEnable = FALSE;

static S8 BuffTx[SIZE_TX_BUFF];
static U16 indexBuffTx = 0;
//**************************************************************************************************
// Declarations of local (private) functions
//**************************************************************************************************

// None.



//**************************************************************************************************
//==================================================================================================
// Definitions of global (public) functions
//==================================================================================================
//**************************************************************************************************



//**************************************************************************************************
// @Function      vMBPortSerialEnable()
//--------------------------------------------------------------------------------------------------
// @Description   Open serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    xRxEnable - enable RX
//                xTxEnable - enable TX  
//**************************************************************************************************
void vMBPortSerialEnable( BOOL xRxEnable, BOOL xTxEnable )
{
    RxEnable = xRxEnable;
    TxEnable = xTxEnable;
}// end of vMBPortSerialEnable



//**************************************************************************************************
// @Function      vMBPortGetStatusRxEnable()
//--------------------------------------------------------------------------------------------------
// @Description   Open serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    xRxEnable - enable RX
//                xTxEnable - enable TX  
//**************************************************************************************************
BOOL vMBPortGetStatusRxEnable( void )
{
    return RxEnable;
}// end of vMBPortGetStatusRxEnable



//**************************************************************************************************
// @Function      vMBPortGetStatusTxEnable()
//--------------------------------------------------------------------------------------------------
// @Description   Open serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    xRxEnable - enable RX
//                xTxEnable - enable TX  
//**************************************************************************************************
BOOL vMBPortGetStatusTxEnable( void )
{
    return TxEnable;
}// end of vMBPortGetStatusTxEnable


//**************************************************************************************************
// @Function      xMBPortSerialInit()
//--------------------------------------------------------------------------------------------------
// @Description   Initial serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   true - not initialized
//                flase - initialized  
//--------------------------------------------------------------------------------------------------
// @Parameters    ucPort - 
//                ulBaudRate - baudrate
//                ucDataBits - number data bits
//                eParity - party  
//**************************************************************************************************
BOOL xMBPortSerialInit( UCHAR ucPort, 
                        ULONG ulBaudRate,
                        UCHAR ucDataBits, 
                        eMBParity eParity )
{

   xMBPortClearTxBuff( );
    
    return TRUE;
} // end of xMBPortSerialInit()



//**************************************************************************************************
// @Function      vMBPortSerialClose()
//--------------------------------------------------------------------------------------------------
// @Description   Close serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void vMBPortSerialClose( void )
{
	// Disable USART
    //USART_Cmd(LORA_UART, DISABLE);
    
}// end of vMBPortSerialClose



//**************************************************************************************************
// @Function      vMBPortClose()
//--------------------------------------------------------------------------------------------------
// @Description   Close serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void vMBPortClose( void )
{
    // Disable USART
    //USART_Cmd(LORA_UART, DISABLE);
    
}// end of vMBPortClose




//**************************************************************************************************
// @Function      xMBPortSerialPutByte()
//--------------------------------------------------------------------------------------------------
// @Description   Send data
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
BOOL xMBPortSerialPutByte( CHAR ucByte )
{
    if (indexBuffTx == SIZE_TX_BUFF)
    {
        indexBuffTx = 0;
    }
    if (0x0D == ucByte)
    {
        BuffTx[indexBuffTx++] = '0';
        BuffTx[indexBuffTx++] = 'D';
    }
    else if  (0x0A == ucByte)
    {
        BuffTx[indexBuffTx++] = '0';
        BuffTx[indexBuffTx++] = 'A';
    }
    else
    {
        snprintf(&BuffTx[indexBuffTx],3,"%X",ucByte);
        indexBuffTx+=2;
    }
    
   return TRUE;
}// end of xMBPortSerialPutByte



//**************************************************************************************************
// @Function      xMBPortSerialPutByte()
//--------------------------------------------------------------------------------------------------
// @Description   Send data
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void xMBPortClearTxBuff( void )
{
    for(U16 i=0;i<SIZE_TX_BUFF;i++)
    {
        BuffTx[i]=0;
    }
    indexBuffTx = 0;
}



//**************************************************************************************************
// @Function      xMBPortGetDataTxBuff()
//--------------------------------------------------------------------------------------------------
// @Description   Send data
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
void xMBPortGetDataTxBuff( S8* pData, const U16 size )
{
    for(U16 i=0;i<size;i++)
    {
        *pData = BuffTx[i];
        pData++;
    }
}// end of xMBPortGetDataTxBuff



//**************************************************************************************************
// @Function      xMBPortGetSizeDataTxBuff()
//--------------------------------------------------------------------------------------------------
// @Description   Send data
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    None.
//**************************************************************************************************
U16 xMBPortGetSizeDataTxBuff( void )
{
  return indexBuffTx;
}// end of xMBPortGetSizeDataTxBuff



//**************************************************************************************************
// @Function      xMBPortSerialGetByte()
//--------------------------------------------------------------------------------------------------
// @Description   Get byte from serial port
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    pucByte - pointer where store byte
//**************************************************************************************************
BOOL xMBPortSerialGetByte( CHAR * pucByte )
{
    *pucByte = ModBusRXByte;

    return TRUE;
}// end of xMBPortSerialGetByte



//**************************************************************************************************
// @Function      xMBPortSerialPutByteInRxBuf()
//--------------------------------------------------------------------------------------------------
// @Description   Put Byte In RxBuf
//--------------------------------------------------------------------------------------------------
// @Notes         None.  
//--------------------------------------------------------------------------------------------------
// @ReturnValue   None.
//--------------------------------------------------------------------------------------------------
// @Parameters    pucByte - pointer where store byte
//**************************************************************************************************
void xMBPortSerialPutByteInRxBuf( CHAR * pucByte )
{
    ModBusRXByte = *pucByte;
    
}// end of xMBPortSerialPutByteInRxBuf



//**************************************************************************************************
//==================================================================================================
// Definitions of local (private) functions
//==================================================================================================
//**************************************************************************************************

// None.


//****************************************** end of file *******************************************
